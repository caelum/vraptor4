<!DOCTYPE HTML> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <title>VRaptor 4 - Using @ConversationScoped on VRaptor 4</title> <link rel="shortcut icon" href="../../../img/favicon.png"> <link rel="stylesheet" href="/css/style.min.css"/> <meta name="generator" content="nanoc 3.6.7"> </head> <body> <header class="container"> <h1 class="logo"><a class="logo-link" href="../.."> <img src="../../../img/logo.png" alt="VRaptor"> </a></h1> <div class="header-links"> <ul class="community"> <li><a href="https://groups.google.com/forum/#!forum/caelum-vraptor-en" target="_blank">Google Groups</a></li> <li><a href="https://github.com/caelum/vraptor4/" target="_blank">GitHub</a></li> <li><a href="http://questions.vraptor.org" target="_blank">VRaptor Questions</a></li> </ul> <ul class="site-languages"> <li> <a class="site-language flag flag-en " title="en" href="../.."> EN </a> </li> <li> <a class="site-language flag flag-pt not-selected" title="pt" href="../../../pt"> PT </a> </li> </ul> <a href="../../search/" class="site-search-link">Go to search page</a> <form action="/en/search/" method="get" class="site-search-form"> <input type="search" name="q"> <button type="submit">Search</button> </form> </div> </header> <input type="checkbox" id="nav-visibility"> <label for="nav-visibility" class="nav-toggle">Menu</label> <nav class="main-nav"> <ul> <li><a href="../../download">Download</a></li> <li><a href="../../docs/one-minute-guide/">Documentation</a></li> <li><a href="../accepting-urls-ending-with-a-slash">Cookbook</a></li> <li><a href="https://github.com/caelum/vraptor4/releases" target="_blank">Changelog</a></li> <li><a href="https://github.com/caelum/vraptor4/milestones" target="_blank">Roadmap</a></li> <li><a href="../../../javadoc">Javadoc</a></li> </ul> </nav> <div class="breadcrumbs"> <a href="../../">Home</a> <a href="../">Cookbook</a> <a href="./">Using @ConversationScoped on VRaptor 4</a> </div> <nav class="doc-nav container"> <h1>Cookbook</h1> <ul> <li> <a href="../accepting-urls-ending-with-a-slash"> Accepting URLs ending with a slash </a> </li> <li> <a href="../building-a-web-application-with-java8-vraptor4-wildfly"> Building a Web Application with Java 8 and VRaptor4 on Wildfly </a> </li> <li> <a href="../avoiding-browser-cache"> Avoiding browser cache </a> </li> <li> <a href="../using-the-referer-header-to-redirect"> Using Referer Header to redirect </a> </li> <li> <a href="../integrating-vraptor-with-tiles3"> Integrating VRaptor with Tiles 3 </a> </li> </ul> </nav> <main class="container"> <h1 id="using-conversationscoped-on-vraptor-4">Using @ConversationScoped on VRaptor 4</h1> <p>VRaptor in its 4th version uses CDI 1.1. And one of the things to be considered when using CDI is the scope of your managed objects. We should always choose carefully the bean scope, since using a <code>@RequestScoped</code> where an <code>@ApplicationScoped</code> is required can be a disaster.</p> <p>A very useful CDI scope is <code>@ConversationScoped</code>, that allows us a greater and more flexible control according to our needs. The application presented in this tutorial is available on GitHub [ScoreCDI] (https://github.com/angeliski/ScoreCDI) in portuguese.</p> <p>Take a look at the controller below:</p> <pre><code class="language-java"><span class="kn">package</span> <span class="n">br</span><span class="o">.</span><span class="na">com</span><span class="o">.</span><span class="na">angeliski</span><span class="o">.</span><span class="na">controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.enterprise.context.Conversation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.enterprise.context.ConversationScoped</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">br.com.caelum.vraptor.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">br.com.caelum.vraptor.Get</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">br.com.caelum.vraptor.Post</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">br.com.caelum.vraptor.Result</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@ConversationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">943045823176068998L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Result</span> <span class="n">result</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Conversation</span> <span class="n">conversation</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">questionResult</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">total</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * @deprecated CDI eyes only</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="nf">HomeController</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">HomeController</span><span class="o">(</span><span class="n">Result</span> <span class="n">result</span><span class="o">,</span> <span class="n">Conversation</span> <span class="n">conversation</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">conversation</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Get</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Get</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">game</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">conversation</span><span class="o">.</span><span class="na">isTransient</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">conversation</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"cid"</span><span class="o">,</span> <span class="n">conversation</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">generateQuestion</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">generateQuestion</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
        <span class="n">Integer</span> <span class="n">firstValue</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="n">Integer</span> <span class="n">secondValue</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>

        <span class="n">questionResult</span> <span class="o">=</span> <span class="n">firstValue</span> <span class="o">*</span> <span class="n">secondValue</span><span class="o">;</span>

        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"first"</span><span class="o">,</span> <span class="n">firstValue</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"second"</span><span class="o">,</span> <span class="n">secondValue</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Post</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">game</span><span class="o">(</span><span class="n">Integer</span> <span class="n">answer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">questionResult</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">answer</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">total</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">generateQuestion</span><span class="o">();</span>
        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"cid"</span><span class="o">,</span> <span class="n">conversation</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Get</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">end</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">conversation</span><span class="o">.</span><span class="na">isTransient</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">conversation</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"total"</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>The first difference of this controller is its scope, defined with <code>@ConversationScoped</code> annotation. It indicates to CDI which will be the controller scope, but be careful: only declaring the annotation is not enough to use this special scope.</p> <p>To make this scope <em>persistent</em>, not losing the data on each request, it is necessary to inject a <code>Conversation</code> object and call its <code>begin</code> method. In example:</p> <pre><code class="language-java"><span class="nd">@Get</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">game</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">conversation</span><span class="o">.</span><span class="na">isTransient</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">conversation</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"cid"</span><span class="o">,</span> <span class="n">conversation</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">generateQuestion</span><span class="o">();</span>
<span class="o">}</span></code></pre> <p>The conversation scope will start at this method. It has a default state known as <em>transient</em>. When the <code>begin</code> method is called, it goes to the <em>long-running</em> state, keeping data until the <code>end</code> method is called. </p> <p>One important detail must be observed. CDI doesn’t know which object you’re dealing with. The way CDI uses to know that is providing an id (called <strong>cid</strong>) to the conversation. We need to provide <strong>cid</strong> as parameter on each url, so CDI can recover the current state. Note that on method <code>game</code> we’re including the <strong>cid</strong> in <code>result</code>.</p> <p>The name used to include the <code>Conversation</code>’s <em>id</em> isn’t really important. It can be anyone, provided it is properly retrieved on the view. It is only important to use the parameter <strong>cid</strong> when the request is sent to the server. </p> <p>Take a look on the page using this parameter:</p> <pre><code class="language-jsp"><span class="err">&lt;</span>\%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"\%&gt;
<span class="err">&lt;</span>\%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"\%&gt;

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>CDI Score<span class="nt">&lt;/title&gt;</span>

<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h4&gt;</span>Current session: ${cid}<span class="nt">&lt;/h4&gt;</span>
    <span class="nt">&lt;p&gt;</span>How much is ${first} * ${second}?<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"${linkTo[HomeController].game}?cid=${cid}"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"answer"</span> <span class="na">type=</span><span class="s">"number"</span> <span class="err">required</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Keep playing!<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"${linkTo[HomeController].end}?cid=${cid}"</span><span class="nt">&gt;</span>Finish!<span class="nt">&lt;/a&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre> <p>You can see that the form action uses the <strong>cid</strong>. When the request is sent to the server, it will send the correct identifier on it.</p> <p>While the request is done by sending the <strong>cid</strong>, the number displayed in the current session will remain the same (because the conversation will remain the same). You can test it by directly accessing <code>/home/game</code> without sending the cid as parameter. A new conversation will be started and the cid will change.</p> <p>Finally, we’ve the <code>end</code> method closing the <em>long-running</em> cycle:</p> <pre><code class="language-java"><span class="nd">@Get</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">end</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">conversation</span><span class="o">.</span><span class="na">isTransient</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">conversation</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"total"</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span>
<span class="o">}</span></code></pre> <p>It’s worth noting that if you don’t finish the conversation, it won’t remain in memory for more than two minutes, which is the standard time. This ensures that, different from <code>@SessionScoped</code>, resources will be released earlier if the application does not shutdown the state of that object. The timeout can be set through <code>setTimeout</code> method if you need, but it’s usually not necessary.</p> </main> <script src="../../../js/search-en.js"></script> <script src="/js/headers.min.js"></script> </body> </html>