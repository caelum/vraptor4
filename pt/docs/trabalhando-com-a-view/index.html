<!DOCTYPE HTML> <html lang="pt"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <title>VRaptor 4 - Trabalhando com a View</title> <link rel="shortcut icon" href="../../../img/favicon.png"> <link rel="stylesheet" href="/css/style.min.css"/> <meta name="generator" content="nanoc 3.6.7"> </head> <body> <header class="container"> <h1 class="logo"><a class="logo-link" href="../.."> <img src="../../../img/logo.png" alt="VRaptor"> </a></h1> <div class="header-links"> <ul class="community"> <li><a href="https://groups.google.com/forum/#!forum/caelum-vraptor" target="_blank">Google Groups</a></li> <li><a href="https://github.com/caelum/vraptor4/" target="_blank">GitHub</a></li> <li><a href="http://www.guj.com.br/tag/vraptor" target="_blank">GUJ Respostas</a></li> </ul> <ul class="site-languages"> <li> <a class="site-language flag flag-en not-selected" title="en" href="../../../en"> EN </a> </li> <li> <a class="site-language flag flag-pt " title="pt" href="../.."> PT </a> </li> </ul> <a href="../../busca/" class="site-search-link">Ir para a página de busca</a> <form action="/pt/busca/" method="get" class="site-search-form"> <input type="search" name="q"> <button type="submit">Buscar</button> </form> </div> </header> <input type="checkbox" id="nav-visibility"> <label for="nav-visibility" class="nav-toggle">Menu</label> <nav class="main-nav"> <ul> <li><a href="../../download">Download</a></li> <li><a href="../guia-de-1-minuto/">Documentação</a></li> <li><a href="../../cookbook/aceitando-urls-com-ou-sem-barra-no-final">Cookbook</a></li> <li><a href="https://github.com/caelum/vraptor4/releases" target="_blank">Changelog</a></li> <li><a href="https://github.com/caelum/vraptor4/milestones" target="_blank">Roadmap</a></li> <li><a href="../../../javadoc">Javadoc</a></li> </ul> </nav> <nav class="doc-nav container"> <h1>Documentação</h1> <ul> <li><a href="../guia-de-1-minuto">Guia inicial de 1 minuto</a></li> <li><a href="../guia-de-10-minutos">Guia inicial de 10 minutos</a></li> <li><a href="../controllers-rest">Controllers Rest</a></li> <li><a href="../componentes">Componentes</a></li> <li><a href="../conversores">Conversores</a></li> <li><a href="../validacao">Validação</a></li> <li><a href="../interceptadores">Interceptadores</a></li> <li><a href="../eventos">Eventos</a></li> <li><a href=".">Trabalhando com a View</a></li> <li><a href="../download-e-upload">Download e Upload</a></li> <li><a href="../environment">Environment</a></li> <li><a href="../plugins">Plugins</a></li> <li><a href="../dependencias-e-pre-requisitos">Dependências e pré requisitos</a></li> <li><a href="../testando-componentes-e-controllers">Testando Componentes e Controllers</a></li> <li><a href="../migrando-de-um-projeto-com-vraptor3">Migrando de um projeto com VRaptor 3</a></li> <li><a href="../contribuindo-com-o-vraptor">Contribuindo com o VRaptor</a></li> <li><a href="../artigos-e-apresentacoes">Artigos e Apresentações</a></li> </ul> </nav> <main class="container doc-container"> <h1 id="compartilhando-objetos-com-a-view">Compartilhando objetos com a view</h1> <p>Para registrar objetos a serem acessados na view, usamos o método include:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">class</span> <span class="nc">ClientController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Result</span> <span class="n">result</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">busca</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"mensagem"</span><span class="o">,</span> <span class="s">"Alguma mensagem"</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"cliente"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Cliente</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Agora as variáveis <code>mensagem</code> e <code>cliente</code> estão disponíveis para uso em seu template engine. É possível registrar o objeto por meio da invocação do método include com um único argumento:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">class</span> <span class="nc">ClientController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Result</span> <span class="n">result</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">busca</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"Alguma mensagem"</span><span class="o">).</span><span class="na">include</span><span class="o">(</span><span class="k">new</span> <span class="n">Cliente</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Nesse caso, a primeira invocação registra a chave <code>string</code> e a segunda, a chave <code>cliente</code>. Você pode alterar o comportamento de convenção de chaves no seu próprio <code>TypeNameExtractor</code>.</p> <h2 id="custom-pathresolver">Custom PathResolver</h2> <p>Por padrão, para renderizar suas views, o VRaptor segue a convenção:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientsController</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">list</span><span class="o">()</span> <span class="o">{</span> 
        <span class="c1">//... </span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Este método acima renderizará a view <code>/WEB-INF/jsp/clients/list.jsp</code>. No entanto, nem sempre queremos esse comportamento, e precisamos usar algum template engine, como por exemplo, Freemarker ou Velocity, e precisamos mudar essa convenção. Um jeito fácil de mudar essa convenção é estendendo a classe <code>DefaultPathResolver</code>:</p> <pre><code class="language-java"><span class="nd">@Specializes</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FreemarkerPathResolver</span> <span class="kd">extends</span> <span class="n">DefaultPathResolver</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getPrefix</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"/WEB-INF/freemarker/"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getExtension</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"ftl"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Desse jeito, a lógica irá renderizar a view <code>/WEB-INF/freemarker/clients/list.ftl</code>. Se, ainda assim, isso não for o suficiente, você pode implementar a interface <code>PathResolver</code> e fazer qualquer convenção que você queira, não esquecendo de anotar a classe com <code>@Specializes</code>.</p> <h2 id="view">View</h2> <p>Se você quiser mudar a view de alguma lógica específica, você pode usar o objeto <code>Result</code>:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientsController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Result</span> <span class="n">result</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">list</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="n">Client</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//...</span>
        <span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">Results</span><span class="o">.</span><span class="na">logic</span><span class="o">()).</span><span class="na">redirectTo</span><span class="o">(</span><span class="n">ClientsController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Por padrão, existem estes tipos de views implementadas:</p> <table class="content-table"> <tbody> <tr> <td>Results.logic()</td> <td>que vai redirecionar para uma outra lógica qualquer do sistema</td> </tr> <tr> <td>Results.page()</td> <td>que vai redirecionar diretamente para uma página, podendo ser um JSP, um HTML, ou qualquer URI relativa ao web application dir, ou ao contexto da aplicação.</td> </tr> <tr> <td>Results.http()</td> <td>que manda informações do protocolo HTTP como status codes e headers.</td> </tr> <tr> <td>Results.status()</td> <td>manda status codes com mais informações.</td> </tr> <tr> <td>Results.referer()</td> <td>que usa o header Referer para fazer redirects ou forwards.</td> </tr> <tr> <td>Results.nothing()</td> <td>apenas retorna o código de sucesso (HTTP 200 OK).</td> </tr> <tr> <td>Results.xml()</td> <td>serializa objetos em XML.</td> </tr> <tr> <td>Results.json()</td> <td>serializa objetos em JSON.</td> </tr> <tr> <td>Results.representation()</td> <td>serializa objetos em um formato determinado pela requisição (parâmetro _format ou header Accept)</td> </tr> </tbody> </table> <h2 id="atalhos-no-result">Atalhos no Result</h2> <p>Alguns redirecionamentos são bastante utilizados, então foram criados atalhos para eles. Os atalhos disponíveis são:</p> <table class="content-table"> <tbody> <tr> <td>result.forwardTo(“/some/uri”)</td> <td>result.use(page()).forward(“/some/uri”);</td> </tr> <tr> <td>result.redirectTo(“/some/uri”)</td> <td>result.use(page()).redirect(“/some/uri)</td> </tr> <tr> <td>result.permanentlyRedirectTo(“/some/uri”)</td> <td>result.use(status()).movedPermanentlyTo(“/some/uri”);</td> </tr> <tr> <td>result.forwardTo(ClientController.class).list()</td> <td>result.use(logic()).forwardTo(ClientController.class).list();</td> </tr> <tr> <td>result.redirectTo(ClientController.class).list()</td> <td>result.use(logic()).redirectTo(ClientController.class).list();</td> </tr> <tr> <td>result.of(ClientController.class).list()</td> <td>result.use(page()).of(ClientController.class).list();</td> </tr> <tr> <td>result.permanentlyRedirectTo(Controller.class)</td> <td>use(status()).movedPermanentlyTo(Controller.class);</td> </tr> <tr> <td>result.notFound()</td> <td>use(status()).notFound()</td> </tr> <tr> <td>result.nothing()</td> <td>use(nothing());</td> </tr> </tbody> </table> <p>Além disso, se o redirecionamento é para um método do mesmo Controller, podemos usar:</p> <table class="content-table"> <tbody> <tr> <td>result.forwardTo(this).list()</td> <td>result.use(logic()).forwardTo(this.getClass()).list();</td> </tr> <tr> <td>result.redirectTo(this).list()</td> <td>result.use(logic()).redirectTo(this.getClass()).list();</td> </tr> <tr> <td>result.of(this).list()</td> <td>result.use(page()).of(this.getClass()).list();</td> </tr> <tr> <td>result.permanentlyRedirectTo(this)</td> <td>use(status()).movedPermanentlyTo(this.getClass());</td> </tr> </tbody> </table> <h2 id="redirecionamento-e-forward">Redirecionamento e forward</h2> <p>No VRaptor, podemos tanto realizar um redirect ou um forward do usuário para uma outra lógica ou um JSP. Apesar de serem conceitos da API de Servlets, vale a pena relembrar a diferença: o redirecionamento acontece no lado do cliente, através de códigos HTTP que farão o browser acessar uma nova URL; já o forward acontece no lado do servidor, totalmente transparente para o cliente/browser.</p> <p>Um bom exemplo de uso do redirect é no chamado ‘redirect-after-post’. Por exemplo: quando você adiciona um cliente e que, após o formulário submetido, o cliente seja retornado para a página de listagem de clientes. Fazendo isso com redirect, impedimos que o usuário atualize a página (F5) e reenvie toda a requisição, acarretando em dados duplicados.</p> <p>No caso do forward, um exemplo de uso é quando você possui uma validação e essa validação falhou, geralmente você quer que o usuário continue na mesma tela do formulário com os dados da requisição preenchidos, mas internamente você vai fazer o forward para outra lógica de negócios (a que prepara os dados necessários para o formulário).</p> <h2 id="escopo-flash-automtico">Escopo Flash automático</h2> <p>Se você adicionar objetos no <code>Result</code> e fizer um Redirect, esses objetos estarão disponíveis na próxima requisição.</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">adiciona</span><span class="o">(</span><span class="n">Cliente</span> <span class="n">cliente</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">dao</span><span class="o">.</span><span class="na">adiciona</span><span class="o">(</span><span class="n">cliente</span><span class="o">);</span>
    <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"mensagem"</span><span class="o">,</span> <span class="s">"Cliente adicionado com sucesso"</span><span class="o">);</span>
    <span class="n">result</span><span class="o">.</span><span class="na">redirectTo</span><span class="o">(</span><span class="n">ClientesController</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">lista</span><span class="o">();</span>
<span class="o">}</span></code></pre> <p>lista.jsp:</p> <pre><code class="language-xml"><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"mensagem"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>${mensagem}<span class="nt">&lt;/h3&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre> <h2 id="accepts-e-o-parmetro-format">Accepts e o parâmetro _format</h2> <p>Muitas vezes, precisamos renderizar formatos diferentes para uma mesma lógica. Por exemplo queremos retornar um JSON, em vez de um HTML. Para fazer isso, podemos definir o Header Accepts da requisição para que aceite o tipo desejado, ou colocar um parâmetro <code>_format</code> na requisição.</p> <p>Se o formato for JSON, a view renderizada por padrão será: <code>/WEB-INF/jsp/{controller}/{logic}.json.jsp</code>, ou seja, em geral será renderizada a view: <code>/WEB-INF/jsp/{controller}/{logic}.{formato}.jsp</code>. Se o formato for HTML você não precisa colocá-lo no nome do arquivo. O parâmetro <code>_format</code> tem prioridade sobre o header Accepts.</p> <h2 id="ajax-construindo-na-view">Ajax: construindo na view</h2> <p>Para devolver um JSON na sua view, basta que sua lógica disponibilize o objeto para a view, e dentro da view você forme o JSON como desejar. Como no exemplo, o seu <code>/WEB-INF/jsp/clients/load.json.jsp</code>:</p> <pre><code class="language-javascript"><span class="p">{</span> <span class="nx">nome</span><span class="o">:</span> <span class="s1">'${client.name}'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">'${client.id}'</span> <span class="p">}</span></code></pre> <p>E na lógica:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientsController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Result</span> <span class="n">result</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">ClientDao</span> <span class="n">dao</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">load</span><span class="o">(</span><span class="n">Client</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"client"</span><span class="o">,</span> <span class="n">dao</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">client</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <h2 id="ajax-verso-programtica">Ajax: Versão programática</h2> <p>Se você quiser que o VRaptor serialize automaticamente seus objetos para XML ou JSON, você pode escrever em sua lógica:</p> <pre><code class="language-java"><span class="kn">import</span> <span class="nn">static</span> <span class="n">br</span><span class="o">.</span><span class="na">com</span><span class="o">.</span><span class="na">caelum</span><span class="o">.</span><span class="na">vraptor</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">Results</span><span class="o">.*;</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientsController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">Result</span> <span class="n">result</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">ClientDao</span> <span class="n">dao</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">loadJson</span><span class="o">(</span><span class="n">Cliente</span> <span class="n">cliente</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">cliente</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">loadXml</span><span class="o">(</span><span class="n">Cliente</span> <span class="n">cliente</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">xml</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">cliente</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Os resultados vão ser parecidos com:</p> <pre><code class="language-javascript"><span class="p">{</span><span class="s2">"cliente"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Joao"</span>
<span class="p">}}</span></code></pre> <p>e em xml:</p> <pre><code class="language-xml"><span class="nt">&lt;cliente&gt;</span>
    <span class="nt">&lt;nome&gt;</span>Joao<span class="nt">&lt;/nome&gt;</span>
<span class="nt">&lt;/cliente&gt;</span></code></pre> <p>Por padrão, apenas campos de tipos primitivos serão serializados (String, números, enums, datas), se você quiser incluir um campo de tipo não primitivo você precisa incluí-lo explicitamente:</p> <pre><code class="language-java"><span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">cliente</span><span class="o">).</span><span class="na">include</span><span class="o">(</span><span class="s">"endereco"</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span></code></pre> <p>Vai resultar em algo parecido com:</p> <pre><code class="language-javascript"><span class="p">{</span><span class="s2">"cliente"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Joao"</span><span class="p">,</span>
    <span class="s2">"endereco"</span> <span class="p">{</span>
        <span class="s2">"rua"</span><span class="o">:</span> <span class="s2">"Vergueiro"</span>
    <span class="p">}</span>
<span class="p">}}</span></code></pre> <p>Você pode também excluir alguns da serialização:</p> <pre><code class="language-java"><span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">usuario</span><span class="o">).</span><span class="na">exclude</span><span class="o">(</span><span class="s">"senha"</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span></code></pre> <p>Vai resultar em algo parecido com:</p> <pre><code class="language-javascript"><span class="p">{</span><span class="s2">"usuario"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Joao"</span><span class="p">,</span>
    <span class="s2">"login"</span><span class="o">:</span> <span class="s2">"joao"</span>
<span class="p">}}</span></code></pre> <p>Você também pode excluir ou incluir vários campos.</p> <pre><code class="language-java"><span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">usuario</span><span class="o">).</span><span class="na">recursive</span><span class="o">().</span><span class="na">serialize</span><span class="o">();</span> <span class="c1">// inclui todos os campos recursivamente</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">xml</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">usuario</span><span class="o">).</span><span class="na">exclude</span><span class="o">(</span><span class="s">"email"</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span> <span class="c1">// excluir o campo email</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">xml</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">usuario</span><span class="o">).</span><span class="na">excludeAll</span><span class="o">().</span><span class="na">serialize</span><span class="o">();</span> <span class="c1">// exclui todos os campos</span></code></pre> <p>Você pode adicionar versionamento aos seus resultados baseados em JSON. Através desse recurso é possível versionar uma API. Para exemplificar a utilidade do versionamento, suponha que foi criada uma API que retorna clientes de um determinado sistema. A primeira versão, retorna clientes definidos através da seguinte estrutura:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cliente</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nome</span><span class="o">;</span>    
    <span class="kd">private</span> <span class="n">String</span> <span class="n">ramo</span><span class="o">;</span>

    <span class="c1">// getters e setters omitidos</span>
<span class="o">}</span></code></pre> <p>Agora suponha que você criou um método no seu controlador que possui o seguinte resultado:</p> <pre><code class="language-java"><span class="nd">@Get</span><span class="o">{</span><span class="s">"/clientes"</span><span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clientes</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Cliente</span><span class="o">&gt;</span> <span class="n">clientes</span> <span class="o">=</span> <span class="n">repositorioDeClientes</span><span class="o">.</span><span class="na">getAll</span><span class="o">();</span>
    <span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">clientes</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span>    
<span class="o">}</span></code></pre> <p>Até agora não há problema algum. Porém, caso seja necessário disponibilizar um novo atributo como resultado que só fará sentido para uma nova versão da API, como poderíamos contornar a situação? Poderiamos criar uma segunda classe chamada ClienteV2 com o novo atributo e o método do controlador que retorna os clientes poderia ser reescrito conforme abaixo:</p> <pre><code class="language-java"><span class="nd">@Get</span><span class="o">{</span><span class="s">"/{versaoParam}/clientes"</span><span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clientes</span><span class="o">(</span><span class="n">String</span> <span class="n">versaoParam</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">double</span> <span class="n">versao</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">versaoParam</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">versao</span> <span class="o">==</span> <span class="mf">2.0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">repositorioDeClientes</span><span class="o">.</span><span class="na">getAll</span><span class="o">()).</span><span class="na">serialize</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">repositorioDeClientes</span><span class="o">.</span><span class="na">getAllFromV2</span><span class="o">()).</span><span class="na">serialize</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Certamente a solução acima não é nada boa. Como o VRaptor utiliza a biblioteca GSON (criada pelo Google), podemos utilizar a mesma classe Cliente utilizando a anotação @Since nos atributos que queremos versionar. Essa anotação indica que um determinado atributo está disponível apartir de uma versão <em>x</em> conforme o exemplo abaixo:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cliente</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nome</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">ramo</span><span class="o">;</span>

    <span class="nd">@Since</span><span class="o">(</span><span class="mf">2.0</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Calendar</span> <span class="n">dataDeRegistro</span><span class="o">;</span>    

    <span class="c1">// getters e setters omitidos</span>
<span class="o">}</span></code></pre> <p>Dessa forma o método do controlador agora pode ser reescrito da seguinte forma:</p> <pre><code class="language-java"><span class="nd">@Get</span><span class="o">{</span><span class="s">"/{versaoParam}/clientes"</span><span class="o">}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clientes</span><span class="o">(</span><span class="n">String</span> <span class="n">versaoParam</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">double</span> <span class="n">versao</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">versaoParam</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Cliente</span><span class="o">&gt;</span> <span class="n">clientes</span> <span class="o">=</span> <span class="n">repositorioDeClientes</span><span class="o">.</span><span class="na">getAll</span><span class="o">();</span>
    <span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">version</span><span class="o">(</span><span class="n">versao</span><span class="o">).</span><span class="na">from</span><span class="o">(</span><span class="n">clientes</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span>
<span class="o">}</span></code></pre> <p>Pronto, agora os clientes de nossa API, podem solicitar um resultado com uma versão específica.</p> <p>A implementação para serialização de XML padrão é baseada no XStream, então é possível configurar a serialização por anotações ou configurações diretas ao XStream, bastando criar a classe:</p> <pre><code class="language-java"><span class="nd">@Specializes</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomXStreamBuilder</span> <span class="kd">extends</span> <span class="n">XStreamBuilderImpl</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">XStream</span> <span class="nf">xmlInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">XStream</span> <span class="n">xStream</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">xmlInstance</span><span class="o">();</span>
        <span class="c1">//suas configurações ao XStream aqui</span>
        <span class="k">return</span> <span class="n">xStream</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Para configurar a serialização com JSON você pode criar uma classe que estenda de <code>GsonJSONSerialization</code> e sobrescrever o método <code>getSerializer()</code> com as suas configurações.</p> <p>Na serialização JSON você pode utilizar a anotação <code>SkipSerialization</code> para omitir a serialização de um campo ou de uma classe.</p> <p>A classe abaixo foi anotada com <code>SkipSerialization</code>, portanto os seus campos nunca serão serializados para JSON:</p> <pre><code class="language-java"><span class="nd">@SkipSerialization</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserPrivateInfo</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">cpf</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">telefone</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">endereco</span><span class="o">;</span>
    
    <span class="c1">// getters e setters</span>
<span class="o">}</span></code></pre> <p>Nesta outra classe, o campo senha não será serializado. O campo info também não será serializado pois a classe <code>UserPrivateInfo</code> foi anotado com <code>SkipSerialization</code>:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">nome</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">login</span><span class="o">;</span>
    
    <span class="nd">@SkipSerialization</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">senha</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="n">UserPrivateInfo</span> <span class="n">info</span><span class="o">;</span>
    
    <span class="c1">// getters e setters</span>
<span class="o">}</span></code></pre> <p>Realizando a seguinte chamada:</p> <pre><code class="language-java"><span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">withoutRoot</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">user</span><span class="o">).</span><span class="na">recursive</span><span class="o">().</span><span class="na">serialize</span><span class="o">();</span></code></pre> <p>O resultado obtido é semelhante à:</p> <pre><code class="language-javascript"><span class="p">{</span>
    <span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Joao"</span><span class="p">,</span>
    <span class="s2">"login"</span><span class="o">:</span> <span class="s2">"joao"</span>
<span class="p">}</span></code></pre> <p>Perceba que o campo senha e todo o <code>UserPrivateInfo</code> não foram serializados.</p> <h2 id="serializando-collections">Serializando Collections</h2> <p>Ao serializar coleções, o padrão é colocar a tag <code>list</code> em volta dos elementos:</p> <pre><code class="language-java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Cliente</span><span class="o">&gt;</span> <span class="n">clientes</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">clientes</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span>
<span class="c1">//ou</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">xml</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">clientes</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span></code></pre> <p>Vai resultar em algo como:</p> <pre><code class="language-javascript"><span class="p">{</span><span class="s2">"list"</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Joao"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Maria"</span> <span class="p">}</span>
<span class="p">]}</span></code></pre> <p>ou</p> <pre><code class="language-xml"><span class="nt">&lt;list&gt;</span>
    <span class="nt">&lt;cliente&gt;</span>
        <span class="nt">&lt;nome&gt;</span>Joao<span class="nt">&lt;/nome&gt;</span>
    <span class="nt">&lt;/cliente&gt;</span>
    <span class="nt">&lt;cliente&gt;</span>
        <span class="nt">&lt;nome&gt;</span>Maria<span class="nt">&lt;/nome&gt;</span>
    <span class="nt">&lt;/cliente&gt;</span>
<span class="nt">&lt;/list&gt;</span></code></pre> <p>É possível personalizar o elemento de fora usando o método:</p> <pre><code class="language-java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Cliente</span><span class="o">&gt;</span> <span class="n">clientes</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">clientes</span><span class="o">,</span> <span class="s">"clientes"</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span>
<span class="c1">//ou</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">xml</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">clientes</span><span class="o">,</span> <span class="s">"clientes"</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span></code></pre> <p>Vai resultar em algo como:</p> <pre><code class="language-javascript"><span class="p">{</span><span class="s2">"clientes"</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Joao"</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Maria"</span><span class="p">}</span>
<span class="p">]}</span></code></pre> <p>ou</p> <pre><code class="language-xml"><span class="nt">&lt;clientes&gt;</span>
    <span class="nt">&lt;cliente&gt;</span>
        <span class="nt">&lt;nome&gt;</span>Joao<span class="nt">&lt;/nome&gt;</span>
    <span class="nt">&lt;/cliente&gt;</span>
    <span class="nt">&lt;cliente&gt;</span>
        <span class="nt">&lt;nome&gt;</span>Maria<span class="nt">&lt;/nome&gt;</span>
    <span class="nt">&lt;/cliente&gt;</span>
<span class="nt">&lt;/clientes&gt;</span></code></pre> <p>Os includes e excludes funcionam como se você os estivesse aplicando num elemento de dentro da lista. Por exemplo se você quiser incluir o endereço no cliente:</p> <pre><code class="language-java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Cliente</span><span class="o">&gt;</span> <span class="n">clientes</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">clientes</span><span class="o">).</span><span class="na">include</span><span class="o">(</span><span class="s">"endereco"</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span></code></pre> <p>Com resultado:</p> <pre><code class="language-javascript"><span class="p">{</span><span class="s2">"list"</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Joao"</span><span class="p">,</span>
        <span class="s2">"endereco"</span><span class="o">:</span> <span class="p">{</span> <span class="s2">"rua"</span><span class="o">:</span> <span class="s2">"Vergueiro, 3185"</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">"nome"</span><span class="o">:</span> <span class="s2">"Maria"</span><span class="p">,</span>
        <span class="s2">"endereco"</span><span class="o">:</span> <span class="p">{</span> <span class="s2">"rua"</span><span class="o">:</span> <span class="s2">"Vergueiro, 3185"</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]}</span></code></pre> <h2 id="serializando-json-sem-elemento-raiz">Serializando JSON sem elemento raiz</h2> <p>Se você quiser serializar um objeto em JSON sem dar nomes a eles, pode fazer isso com o método withoutRoot:</p> <pre><code class="language-java"><span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">from</span><span class="o">(</span><span class="n">carro</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span> <span class="c1">//=&gt; {'carro': {'cor': 'azul'}}</span>
<span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">withoutRoot</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">carro</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span> <span class="c1">//=&gt; {'cor': 'azul'}</span></code></pre> <h2 id="indentao-do-resultado-json-e-xml">Indentação do resultado JSON e XML</h2> <p>Por padrão, o resultado da serialização é sem indentação, o que pode ser útil para melhorar o tempo de download do browser. Porém se você precisar exibir o resultado do JSON ou XML com indentação, você pode usar o método <code>indented</code>.</p> <pre><code class="language-java"><span class="n">result</span><span class="o">.</span><span class="na">use</span><span class="o">(</span><span class="n">json</span><span class="o">()).</span><span class="na">indented</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">carro</span><span class="o">).</span><span class="na">serialize</span><span class="o">();</span></code></pre> <p>Dessa forma o resultado seria:</p> <pre><code class="language-javascript"><span class="p">{</span>
  <span class="s1">'carro'</span><span class="o">:</span>
  <span class="p">{</span>
    <span class="s1">'cor'</span><span class="o">:</span> <span class="s1">'azul'</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre> <p>Ou você pode também usar o <a href="../environment">Environment</a> para definir a indentação padrão conforme o ambiente. Neste caso você pode definir que no ambiente <code>DEVELOPMENT</code> a indentação será ativada, e no ambiente <code>PRODUCTION</code> será desativada.</p> <p><code>development.properties</code>:</p> <pre><code class="language-properties"><span class="na">br.com.caelum.vraptor.serialization.xml.indented</span><span class="o">=</span><span class="s">true</span>
<span class="na">br.com.caelum.vraptor.serialization.json.indented</span><span class="o">=</span><span class="s">true</span></code></pre> <p><code>production.properties</code>:</p> <pre><code class="language-properties"><span class="na">br.com.caelum.vraptor.serialization.xml.indented</span><span class="o">=</span><span class="s">false</span>
<span class="na">br.com.caelum.vraptor.serialization.json.indented</span><span class="o">=</span><span class="s">false</span></code></pre> <p><strong>Nota:</strong> A configuração do <code>Environment</code> possui prioridade menor que no código. Ou seja, se você definir <code>br.com.caelum.vraptor.serialization.xml.indented=false</code> no <code>Environment</code> e chamar o método <code>indented</code> no seu código, o resultado será um JSON ou XML indentado.</p> <h2 id="criando-links-na-view-com-o-linkto">Criando links na view com o linkTo</h2> <p>LinkTo é uma funcionalidade que permite você criar links nas páginas JSP sem precisar escrever o link, mas sim indicando a classe do controller, e o método.</p> <p>Para o seguinte controller:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientController</span> <span class="o">{</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"/client/list"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">list</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// alguma lógica aqui</span>
    <span class="o">}</span>

    <span class="nd">@Path</span><span class="o">(</span><span class="s">"/client/{id}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// alguma lógica aqui</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Para chamar os métodos <code>list</code> e <code>show</code> respectivamente, teriamos que escrever no JSP:</p> <pre><code class="language-jsp"><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/client/list"</span><span class="nt">&gt;</span>listar clientes<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/client/1"</span><span class="nt">&gt;</span>ver cliente 1<span class="nt">&lt;/a&gt;</span></code></pre> <p>Usando a funcionalidade do linkTo, podemos simplicar a chamada para o método <code>list</code>:</p> <pre><code class="language-jsp"><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"${linkTo[ClientController].list()}"</span><span class="nt">&gt;</span>listar clientes<span class="nt">&lt;/a&gt;</span></code></pre> <p>Como o método não possui parâmetros, você também pode omitir os parênteses. </p> <pre><code class="language-jsp"><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"${linkTo[ClientController].list}"</span><span class="nt">&gt;</span>listar clientes<span class="nt">&lt;/a&gt;</span></code></pre> <p>Para chamar o método <code>show</code>, podemos fazer a chamada desta forma:</p> <pre><code class="language-jsp"><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"${linkTo[ClientController].show(1)}"</span><span class="nt">&gt;</span>ver cliente 1<span class="nt">&lt;/a&gt;</span></code></pre> <p>Ao invés do parâmetro fixo, você pode passar variáveis do JSTL, como por exemplo:</p> <pre><code class="language-jsp"><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"${linkTo[ClientController].show(client.id)}"</span><span class="nt">&gt;</span>ver cliente ${client.name}<span class="nt">&lt;/a&gt;</span></code></pre> <h2 id="incluso-automtica-de-parmetros">Inclusão automática de parâmetros</h2> <p>Você pode anotar seu método com <code>@IncludeParameters</code> para que todos os parâmetros de um método do seu controller sejam inclusos automaticamente na <code>view</code>. </p> <p>Então, no lugar de fazer algo como:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">filtra</span><span class="o">(</span><span class="n">Intervalo</span> <span class="n">intervalo</span><span class="o">,</span> <span class="n">Representante</span> <span class="n">representante</span><span class="o">,</span>
        <span class="n">Unidade</span> <span class="n">unidade</span><span class="o">,</span> <span class="n">BigDecimal</span> <span class="n">valorMaximo</span><span class="o">,</span> <span class="n">BigDecimal</span> <span class="n">valorMin</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// lógica de filtro</span>

    <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"intervalo"</span><span class="o">,</span> <span class="n">intervalo</span><span class="o">);</span>
    <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"representante"</span><span class="o">,</span> <span class="n">representante</span><span class="o">);</span>
    <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"valorMaximo"</span><span class="o">,</span> <span class="n">valorMaximo</span><span class="o">);</span>
    <span class="n">result</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="s">"valorMin"</span><span class="o">,</span> <span class="n">valorMin</span><span class="o">);</span>
<span class="o">}</span></code></pre> <p>Agora você pode fazer:</p> <pre><code class="language-java"><span class="nd">@IncludeParameters</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">filtra</span><span class="o">(</span><span class="n">Intervalo</span> <span class="n">intervalo</span><span class="o">,</span> <span class="n">Representante</span> <span class="n">representante</span><span class="o">,</span>
        <span class="n">Unidade</span> <span class="n">unidade</span><span class="o">,</span> <span class="n">BigDecimal</span> <span class="n">valorMaximo</span><span class="o">,</span> <span class="n">BigDecimal</span> <span class="n">valorMin</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// lógica de filtro</span>
<span class="o">}</span></code></pre> <p>Todos os parâmetros estarão disponiveis pela jsp com EL: <code>${intervalo.inicio}</code></p> </main> <script src="../../../js/search-pt.js"></script> <script src="/js/headers.min.js"></script> </body> </html>